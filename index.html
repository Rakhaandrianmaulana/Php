<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <!-- Viewport ini krusial untuk tampilan & fungsi yang benar di iOS dan Android -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kanvas Kolaboratif Sejati</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            /* Mencegah interaksi default browser yang mengganggu di mobile */
            touch-action: none;
        }
        canvas {
            display: block;
            background-color: #F3F4F6; /* Latar belakang kanvas mode terang */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app-container" class="w-screen h-screen relative">
        <canvas id="pixelCanvas"></canvas>

        <!-- Panel Kontrol Bawah -->
        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-white/80 backdrop-blur-sm p-3 rounded-xl shadow-lg flex items-center gap-3 border border-gray-200">
            <input type="color" id="colorPicker" value="#000000" class="w-12 h-12 bg-transparent border-2 border-gray-300 rounded-md cursor-pointer">
            <div id="color-palette" class="flex gap-2.5">
                <!-- Palet warna akan diisi oleh JavaScript -->
            </div>
        </div>

        <!-- Panel Informasi & Status Koneksi (Bukti "No Gimmick") -->
        <div class="absolute top-4 left-4 bg-white/80 backdrop-blur-sm p-4 rounded-xl shadow-lg border border-gray-200 max-w-[250px] text-xs">
            <h1 class="text-base font-bold text-gray-900 mb-2">Kanvas Bersama</h1>
            <div class="text-gray-600 space-y-1.5">
                <p><span class="font-semibold">Satu Jari:</span> Gambar</p>
                <p><span class="font-semibold">Dua Jari:</span> Geser & Zoom</p>
            </div>
             <div class="mt-3 pt-3 border-t border-gray-200">
                <div id="connection-status" class="font-semibold flex items-center gap-2">
                    <!-- Status akan diisi oleh JavaScript untuk menunjukkan status koneksi real-time -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Impor Modul Firebase: Ini adalah fondasi untuk terhubung ke server ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Konfigurasi dan Inisialisasi Koneksi Server ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-true-canvas';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEMO", authDomain: "DEMO", projectId: "DEMO" };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Lokasi penyimpanan data piksel di server. Bersifat publik untuk semua pengguna aplikasi ini.
        const PIXEL_COLLECTION = `/artifacts/${appId}/public/data/pixels`;

        // --- Variabel Global & Elemen UI ---
        const canvas = document.getElementById('pixelCanvas');
        const ctx = canvas.getContext('2d');
        const colorPicker = document.getElementById('colorPicker');
        const connectionStatusEl = document.getElementById('connection-status');

        const GRID_SIZE = 16;
        let pixels = {};
        let currentColor = colorPicker.value;

        // State untuk interaksi sentuh (Pan & Zoom)
        let panOffset = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
        let scale = 1.0;
        let isGesturing = false;
        let initialPinchDistance = 0;
        let lastPanMidpoint = { x: 0, y: 0 };
        let lastDrawnPixel = {x: null, y: null};

        // --- Fungsi UI untuk Status Koneksi ---
        function setConnectionStatus(status, message) {
            const statusMap = {
                connecting: { icon: `<svg class="animate-spin h-4 w-4 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`, color: 'text-yellow-600' },
                connected: { icon: `<span class="h-3 w-3 bg-green-500 rounded-full animate-pulse"></span>`, color: 'text-green-700' },
                error: { icon: `<span class="h-3 w-3 bg-red-500 rounded-full"></span>`, color: 'text-red-700' }
            };
            connectionStatusEl.innerHTML = `${statusMap[status].icon} <span class="${statusMap[status].color}">${message}</span>`;
        }

        // --- Fungsi Inti Aplikasi ---

        function setupCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.imageSmoothingEnabled = false; // Penting untuk seni piksel
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Lebih efisien dari fillRect
            ctx.save();
            ctx.translate(panOffset.x, panOffset.y);
            ctx.scale(scale, scale);
            for (const key in pixels) {
                const p = pixels[key];
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x * GRID_SIZE, p.y * GRID_SIZE, GRID_SIZE, GRID_SIZE);
            }
            if (scale > 5) drawGrid();
            ctx.restore();
        }
        
        function drawGrid() {
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.08)';
            ctx.lineWidth = 1 / scale;
            const view = { x: -panOffset.x / scale, y: -panOffset.y / scale, width: canvas.width / scale, height: canvas.height / scale };
            const startX = Math.floor(view.x / GRID_SIZE) * GRID_SIZE, startY = Math.floor(view.y / GRID_SIZE) * GRID_SIZE;
            const endX = startX + view.width + GRID_SIZE, endY = startY + view.height + GRID_SIZE;
            for (let x = startX; x <= endX; x += GRID_SIZE) { ctx.beginPath(); ctx.moveTo(x, startY); ctx.lineTo(x, endY); ctx.stroke(); }
            for (let y = startY; y <= endY; y += GRID_SIZE) { ctx.beginPath(); ctx.moveTo(startX, y); ctx.lineTo(endX, y); ctx.stroke(); }
        }
        
        // Fungsi ini MENGIRIM data piksel ke server Firestore. Inilah "save otomatis".
        async function placePixel(gridX, gridY, color) {
            if (gridX === lastDrawnPixel.x && gridY === lastDrawnPixel.y) return;
            lastDrawnPixel = {x: gridX, y: gridY};
            const pixelId = `${gridX}_${gridY}`;
            try {
                await setDoc(doc(db, PIXEL_COLLECTION, pixelId), { x: gridX, y: gridY, color: color });
            } catch (error) {
                console.error("Gagal mengirim piksel ke server:", error);
                setConnectionStatus('error', 'Gagal mengirim data');
            }
        }

        function setupPalette() {
            const paletteContainer = document.getElementById('color-palette');
            ['#000000', '#FFFFFF', '#ef4444', '#f59e0b', '#22c55e', '#3b82f6'].forEach(color => {
                const swatch = document.createElement('button');
                swatch.className = 'w-10 h-10 rounded-lg border-2 border-gray-300 active:border-blue-500 transition-all';
                swatch.style.backgroundColor = color;
                swatch.onclick = () => { currentColor = color; colorPicker.value = color; };
                paletteContainer.appendChild(swatch);
            });
        }

        // --- Penanganan Input Sentuh untuk iOS & Android ---
        const getPinchDistance = (touches) => Math.hypot(touches[0].clientX - touches[1].clientX, touches[0].clientY - touches[1].clientY);
        const getMidpoint = (touches) => ({ x: (touches[0].clientX + touches[1].clientX) / 2, y: (touches[0].clientY + touches[1].clientY) / 2 });
        const screenToWorld = (x, y) => ({ x: (x - panOffset.x) / scale, y: (y - panOffset.y) / scale });

        function handleTouch(e) {
            e.preventDefault(); // Mencegah aksi browser default seperti scroll atau zoom halaman
            const worldPos = screenToWorld(e.touches[0].clientX, e.touches[0].clientY);
            const gridX = Math.floor(worldPos.x / GRID_SIZE);
            const gridY = Math.floor(worldPos.y / GRID_SIZE);
            placePixel(gridX, gridY, currentColor);
        }
        
        canvas.addEventListener('touchstart', e => {
            if (e.touches.length === 1) handleTouch(e);
            else if (e.touches.length === 2) {
                isGesturing = true;
                initialPinchDistance = getPinchDistance(e.touches);
                lastPanMidpoint = getMidpoint(e.touches);
            }
        });
        
        canvas.addEventListener('touchmove', e => {
            if (e.touches.length === 1 && !isGesturing) handleTouch(e);
            else if (e.touches.length === 2 && isGesturing) {
                const newMidpoint = getMidpoint(e.touches);
                panOffset.x += newMidpoint.x - lastPanMidpoint.x;
                panOffset.y += newMidpoint.y - lastPanMidpoint.y;
                const newPinchDistance = getPinchDistance(e.touches);
                scale *= newPinchDistance / initialPinchDistance;
                initialPinchDistance = newPinchDistance;
                lastPanMidpoint = newMidpoint;
            }
        });
        
        canvas.addEventListener('touchend', e => {
            isGesturing = e.touches.length > 0;
            lastDrawnPixel = {x: null, y: null};
        });

        // --- Inisialisasi Aplikasi dan Koneksi Server ---
        async function main() {
            setupCanvas();
            setupPalette();
            window.addEventListener('resize', setupCanvas);
            colorPicker.addEventListener('input', (e) => { currentColor = e.target.value; });
            
            setConnectionStatus('connecting', 'Menyambung...');

            try {
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) await signInWithCustomToken(auth, token);
                else await signInAnonymously(auth);
            } catch (e) {
                console.error("Autentikasi gagal:", e);
                setConnectionStatus('error', 'Gagal autentikasi');
                return;
            }

            onAuthStateChanged(auth, user => {
                if (user) {
                    // Ini adalah kunci REAL-TIME. onSnapshot akan berjalan setiap kali ada perubahan di server.
                    const pixelCollectionRef = collection(db, PIXEL_COLLECTION);
                    onSnapshot(pixelCollectionRef, snapshot => {
                        snapshot.docChanges().forEach(change => {
                            pixels[change.doc.id] = change.doc.data();
                        });
                        setConnectionStatus('connected', 'Live! Terhubung');
                    }, error => {
                        console.error("Koneksi data terputus:", error);
                        setConnectionStatus('error', 'Koneksi data putus');
                    });
                }
            });
            
            const animationLoop = () => { draw(); requestAnimationFrame(animationLoop); }
            animationLoop();
        }

        window.onload = main;
    </script>
</body>
</html>

                            
