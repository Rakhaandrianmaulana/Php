<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kanvas Geo-Lokal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            touch-action: none;
        }
        canvas {
            display: block;
            background-color: #F3F4F6;
        }
        /* Style untuk overlay izin lokasi */
        #permission-overlay {
            transition: opacity 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app-container" class="w-screen h-screen relative">
        <canvas id="pixelCanvas"></canvas>

        <!-- UI Kontrol (awalnya tersembunyi) -->
        <div id="drawing-ui" class="opacity-0 transition-opacity duration-500">
            <div class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-white/80 backdrop-blur-sm p-3 rounded-xl shadow-lg flex items-center gap-3 border border-gray-200">
                <input type="color" id="colorPicker" value="#000000" class="w-12 h-12 bg-transparent border-2 border-gray-300 rounded-md cursor-pointer">
                <div id="color-palette" class="flex gap-2.5"></div>
            </div>

            <div class="absolute top-4 left-4 bg-white/80 backdrop-blur-sm p-4 rounded-xl shadow-lg border border-gray-200 max-w-[250px] text-xs">
                <h1 class="text-base font-bold text-gray-900 mb-2">Kanvas Lokal</h1>
                <div id="location-info" class="font-semibold text-blue-600 mb-2">
                    <!-- Info geohash akan diisi di sini -->
                </div>
                <div id="connection-status" class="font-semibold flex items-center gap-2"></div>
            </div>
        </div>
    </div>

    <!-- Overlay untuk Permintaan Izin Lokasi -->
    <div id="permission-overlay" class="absolute inset-0 bg-gray-900/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-sm mx-4">
            <div id="permission-content">
                <h2 class="text-xl font-bold mb-2 text-gray-800">Selamat Datang!</h2>
                <p class="text-gray-600 mb-6">Aplikasi ini memerlukan lokasi Anda untuk menemukan kanvas bersama dengan orang-orang di sekitar. Lokasi Anda tidak akan dibagikan.</p>
                <div id="permission-status" class="flex justify-center items-center gap-3 text-lg font-medium text-yellow-600">
                    <svg class="animate-spin h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span>Meminta izin lokasi...</span>
                </div>
                <button id="retry-location-btn" class="hidden mt-6 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors">Coba Lagi</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Konfigurasi dan Variabel Global ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-geocanvas';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEMO", authDomain: "DEMO", projectId: "DEMO" };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const GEO_CANVAS_BASE_PATH = `/artifacts/${appId}/public/data/geocanvas`;
        const GEOHASH_PRECISION = 7; // Presisi 7 ~ area 150m x 150m. Sempurna untuk "sekitar".

        // Elemen UI
        const canvas = document.getElementById('pixelCanvas'), ctx = canvas.getContext('2d');
        const colorPicker = document.getElementById('colorPicker');
        const permissionOverlay = document.getElementById('permission-overlay');
        const permissionStatus = document.getElementById('permission-status');
        const retryBtn = document.getElementById('retry-location-btn');
        const drawingUI = document.getElementById('drawing-ui');
        const locationInfo = document.getElementById('location-info');
        const connectionStatusEl = document.getElementById('connection-status');
        
        let pixels = {}, currentColor = colorPicker.value, currentGeohash = null;
        const GRID_SIZE = 16;
        let panOffset = { x: 0, y: 0 }, scale = 1.0;
        let isGesturing = false, initialPinchDistance = 0, lastPanMidpoint = { x: 0, y: 0 }, lastDrawnPixel = {x: null, y: null};

        // --- Pustaka Mini Geohash ---
        // Implementasi sederhana untuk menghindari dependensi eksternal
        const BITS = [16, 8, 4, 2, 1];
        const BASE32 = "0123456789bcdefghjkmnpqrstuvwxyz";
        function encodeGeohash(latitude, longitude, precision) {
            let geohash = "";
            let is_even = true;
            let lat = [-90.0, 90.0], lon = [-180.0, 180.0];
            let bit = 0, ch = 0;

            while (geohash.length < precision) {
                let mid;
                if (is_even) {
                    mid = (lon[0] + lon[1]) / 2;
                    if (longitude > mid) {
                        ch |= BITS[bit];
                        lon[0] = mid;
                    } else lon[1] = mid;
                } else {
                    mid = (lat[0] + lat[1]) / 2;
                    if (latitude > mid) {
                        ch |= BITS[bit];
                        lat[0] = mid;
                    } else lat[1] = mid;
                }
                is_even = !is_even;
                if (bit < 4) bit++;
                else {
                    geohash += BASE32[ch];
                    bit = 0; ch = 0;
                }
            }
            return geohash;
        }


        // --- Fungsi Utama Aplikasi ---
        function setConnectionStatus(status, message) {
            const statusMap = {
                connecting: { icon: `<svg class="animate-spin h-4 w-4 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`, color: 'text-yellow-600' },
                connected: { icon: `<span class="h-3 w-3 bg-green-500 rounded-full animate-pulse"></span>`, color: 'text-green-700' },
                error: { icon: `<span class="h-3 w-3 bg-red-500 rounded-full"></span>`, color: 'text-red-700' }
            };
            connectionStatusEl.innerHTML = `${statusMap[status].icon} <span class="${statusMap[status].color}">${message}</span>`;
        }
        
        function setupCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            panOffset = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
            ctx.imageSmoothingEnabled = false;
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(panOffset.x, panOffset.y);
            ctx.scale(scale, scale);
            for (const key in pixels) {
                const p = pixels[key];
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x * GRID_SIZE, p.y * GRID_SIZE, GRID_SIZE, GRID_SIZE);
            }
            if (scale > 5) {
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.08)'; ctx.lineWidth = 1 / scale;
                const view = { x: -panOffset.x / scale, y: -panOffset.y / scale, width: canvas.width / scale, height: canvas.height / scale };
                const startX = Math.floor(view.x / GRID_SIZE) * GRID_SIZE, startY = Math.floor(view.y / GRID_SIZE) * GRID_SIZE;
                const endX = startX + view.width + GRID_SIZE, endY = startY + view.height + GRID_SIZE;
                for (let x = startX; x <= endX; x += GRID_SIZE) { ctx.beginPath(); ctx.moveTo(x, startY); ctx.lineTo(x, endY); ctx.stroke(); }
                for (let y = startY; y <= endY; y += GRID_SIZE) { ctx.beginPath(); ctx.moveTo(startX, y); ctx.lineTo(endX, y); ctx.stroke(); }
            }
            ctx.restore();
        }

        async function placePixel(gridX, gridY, color) {
            if (!currentGeohash || (gridX === lastDrawnPixel.x && gridY === lastDrawnPixel.y)) return;
            lastDrawnPixel = {x: gridX, y: gridY};
            const pixelId = `${gridX}_${gridY}`;
            const pixelDocPath = `${GEO_CANVAS_BASE_PATH}/${currentGeohash}/pixels/${pixelId}`;
            try {
                await setDoc(doc(db, pixelDocPath), { x: gridX, y: gridY, color });
            } catch (error) {
                console.error("Gagal menyimpan piksel:", error);
                setConnectionStatus('error', 'Gagal mengirim');
            }
        }

        // --- Logika Geolokasi & Inisialisasi ---
        function requestLocationAndInitialize() {
            permissionStatus.innerHTML = `<span>Mencari lokasi Anda...</span>`;
            retryBtn.classList.add('hidden');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    currentGeohash = encodeGeohash(latitude, longitude, GEOHASH_PRECISION);
                    
                    locationInfo.textContent = `Area ID: ${currentGeohash}`;
                    permissionOverlay.style.opacity = '0';
                    setTimeout(() => permissionOverlay.style.display = 'none', 500);
                    drawingUI.classList.remove('opacity-0');

                    connectToCanvas(currentGeohash);
                },
                (error) => {
                    let message = "Terjadi kesalahan lokasi.";
                    if (error.code === error.PERMISSION_DENIED) {
                        message = "Izin lokasi ditolak.";
                    }
                    permissionStatus.innerHTML = `<span class="text-red-600">${message} Aplikasi tidak dapat berjalan.</span>`;
                    retryBtn.classList.remove('hidden');
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        async function connectToCanvas(geohash) {
            setConnectionStatus('connecting', 'Menyambung...');
            try {
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) await signInWithCustomToken(auth, token);
                else await signInAnonymously(auth);

                const canvasCollectionPath = `${GEO_CANVAS_BASE_PATH}/${geohash}/pixels`;
                onSnapshot(collection(db, canvasCollectionPath), (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        pixels[change.doc.id] = change.doc.data();
                    });
                    setConnectionStatus('connected', 'Live!');
                }, (error) => {
                    console.error("Koneksi data gagal:", error);
                    setConnectionStatus('error', 'Koneksi putus');
                });
            } catch (e) {
                console.error("Autentikasi gagal:", e);
                setConnectionStatus('error', 'Gagal autentikasi');
            }
        }

        // --- Event Listeners ---
        retryBtn.addEventListener('click', requestLocationAndInitialize);
        colorPicker.addEventListener('input', (e) => { currentColor = e.target.value; });
        window.addEventListener('resize', setupCanvas);

        const screenToWorld = (x, y) => ({ x: (x - panOffset.x) / scale, y: (y - panOffset.y) / scale });
        function handleTouch(e) {
            e.preventDefault();
            const worldPos = screenToWorld(e.touches[0].clientX, e.touches[0].clientY);
            placePixel(Math.floor(worldPos.x / GRID_SIZE), Math.floor(worldPos.y / GRID_SIZE), currentColor);
        }
        
        canvas.addEventListener('touchstart', e => {
            if (e.touches.length === 1) handleTouch(e);
            else if (e.touches.length === 2) {
                isGesturing = true;
                initialPinchDistance = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                lastPanMidpoint = { x: (e.touches[0].clientX + e.touches[1].clientX) / 2, y: (e.touches[0].clientY + e.touches[1].clientY) / 2 };
            }
        });
        canvas.addEventListener('touchmove', e => {
            if (e.touches.length === 1 && !isGesturing) handleTouch(e);
            else if (e.touches.length === 2 && isGesturing) {
                const newMidpoint = { x: (e.touches[0].clientX + e.touches[1].clientX) / 2, y: (e.touches[0].clientY + e.touches[1].clientY) / 2 };
                panOffset.x += newMidpoint.x - lastPanMidpoint.x;
                panOffset.y += newMidpoint.y - lastPanMidpoint.y;
                const newPinchDistance = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                scale *= newPinchDistance / initialPinchDistance;
                initialPinchDistance = newPinchDistance;
                lastPanMidpoint = newMidpoint;
            }
        });
        canvas.addEventListener('touchend', e => { isGesturing = e.touches.length > 0; lastDrawnPixel = {x: null, y: null}; });

        // --- Inisialisasi Saat Halaman Dimuat ---
        window.onload = () => {
            setupCanvas();
            ['#000000', '#FFFFFF', '#ef4444', '#f59e0b', '#22c55e', '#3b82f6'].forEach(color => {
                const swatch = document.createElement('button');
                swatch.className = 'w-10 h-10 rounded-lg border-2 border-gray-300 active:border-blue-500';
                swatch.style.backgroundColor = color;
                swatch.onclick = () => { currentColor = color; colorPicker.value = color; };
                document.getElementById('color-palette').appendChild(swatch);
            });
            
            requestLocationAndInitialize();
            
            const animationLoop = () => { draw(); requestAnimationFrame(animationLoop); }
            animationLoop();
        };
    </script>
</body>
</html>

